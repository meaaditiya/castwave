rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow users to read all chat rooms.
    // Only authenticated users can create rooms.
    // Only the host can update or delete their room.
    match /chatRooms/{roomId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.hostId;

      // Rules for participants subcollection
      match /participants/{userId} {
        // ANY authenticated user can read the participant list. This is needed
        // for the client to check its own status (pending, approved, etc.).
        allow read: if request.auth != null;
        
        // A user can only add THEMSELVES to the participants list.
        allow create: if request.auth.uid == userId;

        // Only the host of the chat room can update a participant's status
        // (e.g., approve, deny, remove).
        allow update: if exists(/databases/$(database)/documents/chatRooms/$(roomId)) &&
                       request.auth.uid == get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId;

        // Only the host can delete a participant document.
        allow delete: if exists(/databases/$(database)/documents/chatRooms/$(roomId)) &&
                       request.auth.uid == get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId;
      }

      // Rules for messages subcollection
      match /messages/{messageId} {
        allow read: if request.auth != null;
        // User must be an approved participant to send messages
        allow create: if request.auth.uid == request.resource.data.userId &&
                       exists(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)).data.status == 'approved';

        // Users can update their own messages (for voting), or the host can.
        allow update: if request.auth.uid == resource.data.userId || 
                       (exists(/databases/$(database)/documents/chatRooms/$(roomId)) &&
                       request.auth.uid == get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId);
        
        allow delete: if exists(/databases/$(database)/documents/chatRooms/$(roomId)) &&
                       request.auth.uid == get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId;
      }
    }
  }
}
