{
  "rules": {
    "users": {
      "$uid": {
        // Any authenticated user can view a user's profile.
        ".read": "request.auth.uid != null",
        // Only the user themselves can write to their own profile.
        ".write": "request.auth.uid == $uid"
      }
    },
    "chatRooms": {
      "$roomId": {
        // Allow reading a chat room if it's not private, OR if the reader is the host.
        ".read": "resource.data.isPrivate == false || (request.auth.uid != null && resource.data.hostId == request.auth.uid)",
        // Allow writing if the user is the host.
        ".write": "request.auth.uid == resource.data.hostId || (request.resource.data.hostId != null && request.auth.uid == request.resource.data.hostId)",
        "participants": {
          "$participantId": {
            ".read": "request.auth.uid != null",
            ".write": "request.auth.uid == resource.data.userId || request.auth.uid == request.resource.data.userId || (exists(/databases/$(database)/documents/chatRooms/$(roomId)) && get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId == request.auth.uid)"
          }
        },
        "messages": {
          "$messageId": {
            ".read": "exists(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)) && get(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)).data.status == 'approved'",
            ".create": "request.auth.uid == request.resource.data.userId && exists(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)) && get(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)).data.status == 'approved'",
            ".update": "request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId == request.auth.uid"
          }
        },
        "polls": {
          "$pollId": {
            ".read": "exists(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid))",
            ".create": "get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId == request.auth.uid",
            ".update": "get(/databases/$(database)/documents/chatRooms/$(roomId)).data.hostId == request.auth.uid || (resource.data.voters[request.auth.uid] == null && exists(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)) && get(/databases/$(database)/documents/chatRooms/$(roomId)/participants/$(request.auth.uid)).data.status == 'approved')"
          }
        }
      }
    }
  }
}
